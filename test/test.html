<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test for Quote Calculator</title>
    <style>
        #test-results li.pass { color: green; }
        #test-results li.fail { color: red; }
    </style>
</head>
<body>

<h1>Quote Calculator Tests</h1>
<ul id="test-results"></ul>

<!-- Minimal DOM for testing -->
<div id="customization-page" style="display: none;">
    <h1 id="customization-title"></h1>
    <h2 id="customization-header"></h2>
    <p id="customization-desc"></p>
    <img id="customization-preview-img" src="" alt="">

    <input type="number" id="length" value="100">
    <input type="number" id="width" value="100">
    <input type="number" id="height" value="100">
    <input type="number" id="quantity" value="1000">

    <div id="material-type-options"></div>
    <div id="grammage-options-container"></div>

    <div>
        <input type="radio" name="surface-treatment" value="哑光覆膜" data-price-factor="1.1" checked>
        <input type="radio" name="surface-treatment" value="亮光覆膜" data-price-factor="1.1">
    </div>

    <div>
        <input type="radio" name="printing-method" value="offset" checked>
        <input type="radio" name="printing-method" value="digital">
        <input type="radio" name="printing-method" value="none">
    </div>
    <div id="spot-color-options">
        <input type="radio" name="printing-spot-color" value="0" data-price-factor="0" checked>
    </div>

    <div id="special-processes-container"></div>

    <div id="inner-tray-options">
        <input type="radio" name="inner-tray-material" value="EVA泡棉" data-price-factor="0.5" checked>
        <input type="radio" name="inner-tray-material" value="纸质内托" data-price-factor="0.3">
        <input type="radio" name="inner-tray-material" value="吸塑内托" data-price-factor="0.4">
        <div id="paper-tray-options">
             <input type="radio" name="paper-tray-type" value="白卡纸" data-price-factor="0.1" checked>
        </div>
        <div id="plastic-tray-options">
            <input type="radio" name="plastic-tray-type" value="PET" data-price-factor="0.15" checked>
        </div>
        <input type="radio" name="inner-tray-color" value="黑色" checked>
    </div>

    <div>
        <input type="checkbox" name="accessories" value="内托" data-price-factor="0.2">
    </div>

    <div>
        <input type="checkbox" name="services" data-price-factor="100">
    </div>
    <div>
        <input type="checkbox" name="sampling-service" data-price-factor="200">
    </div>


    <span id="unit-price">¥ 0.00</span>
    <span id="subtotal-price">¥ 0.00</span>
    <span id="logistics-fee">¥ 0.00</span>
    <span id="total-price">¥ 0.00</span>
    <span id="lead-time">-</span>
</div>

<script src="../js/product-data.js"></script>
<script src="../js/app.js"></script>

<script>
    function runTests() {
        const results = document.getElementById('test-results');

        function assertEquals(actual, expected, message) {
            const li = document.createElement('li');
            if (actual === expected) {
                li.className = 'pass';
                li.textContent = `PASS: ${message}`;
            } else {
                li.className = 'fail';
                li.textContent = `FAIL: ${message}. Expected ${expected}, but got ${actual}`;
            }
            results.appendChild(li);
        }

        function assertAlmostEquals(actual, expected, message, epsilon = 0.01) {
            const li = document.createElement('li');
            if (Math.abs(actual - expected) < epsilon) {
                li.className = 'pass';
                li.textContent = `PASS: ${message}`;
            } else {
                li.className = 'fail';
                li.textContent = `FAIL: ${message}. Expected around ${expected}, but got ${actual}`;
            }
            results.appendChild(li);
        }

        function getPrice() {
            const priceStr = document.getElementById('total-price').textContent;
            return parseFloat(priceStr.replace('¥ ', ''));
        }

        // Initialize form elements
        renderMaterialOptions();
        renderSpecialProcesses();

        // Test 1: Price calculation for Embossed Texture
        function testEmbossedTexture() {
            // Set dimensions
            document.getElementById('length').value = 100;
            document.getElementById('width').value = 50;
            document.getElementById('height').value = 20;
            document.getElementById('quantity').value = 1000;

            // Check the embossed texture checkbox
            const embossedCheckbox = document.querySelector('#embossedTexture-process input[type="checkbox"]');
            embossedCheckbox.checked = true;

            // Trigger update
            updateQuote();

            // Expected cost calculation:
            const length = 100, width = 50, height = 20, quantity = 1000;

            // Base price part
            const area = (length * width + length * height * 2 + width * height * 2) / 100000; // (5000 + 4000 + 2000) / 100000 = 0.11
            const basePrice = area * 5; // 0.11 * 5 = 0.55

            // Factors
            let baseFactor = 1.0; // 白卡纸
            baseFactor *= 1.0; // 305g
            baseFactor *= 1.1; // 哑光覆膜

            // Printing
            baseFactor *= 1.0; // offset

            // additionalCost from printing
            let additionalCost = 0; // 0 spot color

            // Embossed Texture cost
            const embossedConfig = specialProcessesConfig['embossedTexture'];
            const surfaceArea = 2 * (length * width + length * height + width * height); // 2 * (5000 + 2000 + 1000) = 16000
            additionalCost += (surfaceArea * embossedConfig.pricePerSqMm) * quantity; // (16000 * 0.004) * 1000 = 64 * 1000 = 64000

            const unitPrice = basePrice * baseFactor; // 0.55 * 1.1 = 0.605
            const subtotal = (unitPrice * quantity) + additionalCost; // (0.605 * 1000) + 64000 = 605 + 64000 = 64605
            const logisticsFee = quantity * 0.02 + 12; // 20 + 12 = 32
            const expectedTotal = subtotal + logisticsFee; // 64605 + 32 = 64637

            assertAlmostEquals(getPrice(), expectedTotal, 'Embossed texture cost should be calculated correctly');

            // cleanup
            embossedCheckbox.checked = false;
            updateQuote();
        }

        // Test 2: Regression test for Hot Stamping
        function testHotStamping() {
            // Set dimensions
            document.getElementById('length').value = 100;
            document.getElementById('width').value = 50;
            document.getElementById('height').value = 20;
            document.getElementById('quantity').value = 1000;

            // Check the hot stamping checkbox
            const hotStampingCheckbox = document.querySelector('#hotStamping-process input[type="checkbox"]');
            hotStampingCheckbox.checked = true;

            const instance = document.querySelector('#hotStamping-process .process-instance');
            instance.querySelector('[data-param="width"]').value = 30;
            instance.querySelector('[data-param="height"]').value = 20;

            // Trigger update
            updateQuote();

            // Expected cost calculation:
            const length = 100, width = 50, height = 20, quantity = 1000;
            const w = 30, h = 20;

            const area = (length * width + length * height * 2 + width * height * 2) / 100000; // 0.11
            const basePrice = area * 5; // 0.55

            let baseFactor = 1.0 * 1.0 * 1.1 * 1.0; // material * grammage * surface * printing

            let additionalCost = 0; // printing spot color

            // Hot Stamping cost
            const hotStampingConfig = specialProcessesConfig['hotStamping'];
            additionalCost += (w * h * hotStampingConfig.pricePerSqMm) * quantity; // (30 * 20 * 0.005) * 1000 = 3 * 1000 = 3000

            const unitPrice = basePrice * baseFactor; // 0.605
            const subtotal = (unitPrice * quantity) + additionalCost; // 605 + 3000 = 3605
            const logisticsFee = quantity * 0.02 + 12; // 32
            const expectedTotal = subtotal + logisticsFee; // 3605 + 32 = 3637

            assertAlmostEquals(getPrice(), expectedTotal, 'Hot Stamping cost should still be calculated correctly');

            // cleanup
            hotStampingCheckbox.checked = false;
            instance.querySelector('[data-param="width"]').value = '';
            instance.querySelector('[data-param="height"]').value = '';
            updateQuote();
        }

        // Run all tests
        testEmbossedTexture();
        testHotStamping();
    }

    // Run tests when the page is loaded
    window.onload = runTests;
</script>

</body>
</html>
